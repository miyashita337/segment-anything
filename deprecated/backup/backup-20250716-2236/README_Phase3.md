# Phase 3: インタラクティブ補助機能

Phase 1とPhase 2で自動抽出に失敗した複雑な画像に対して、手動介入によるキャラクター抽出を支援する機能です。

## 実装完了機能

### 1. インタラクティブ補助機能コア (`utils/interactive_core.py`)
- **シードポイント指定**: 正負のポイントを指定してSAMでマスク生成
- **バウンディングボックス指定**: 矩形領域を指定してSAMでマスク生成
- **リアルタイムプレビュー**: マスク生成結果の即座確認
- **GUI非依存**: WSL環境でも動作するコア機能

### 2. GUIアプリケーション (`utils/interactive_assistant.py`)
- **直感的操作**: マウスクリック・ドラッグでのポイント・領域指定
- **リアルタイムプレビュー**: マスク結果の即座表示
- **ファイル操作**: 画像読み込み・結果保存の統合UI
- **注意**: tkinter必須のためWSL環境では要X11転送

### 3. コマンドライン版 (`commands/quick_interactive.py`)
- **シードポイント指定**: `--points x1,y1,pos x2,y2,neg`
- **バウンディングボックス指定**: `--region x,y,width,height`
- **バッチ処理対応**: 座標指定による自動化可能

## 使用方法

### 1. GUIアプリケーション (Windows/X11環境)
```bash
python3 commands/interactive_extract.py
```

### 2. コマンドライン（シードポイント）
```bash
# 正のポイント3個で抽出
python3 commands/quick_interactive.py image.jpg --points 750,1000 800,1200 700,800

# 正負のポイント混合
python3 commands/quick_interactive.py image.jpg --points 750,1000,pos 800,1200,pos 500,500,neg
```

### 3. コマンドライン（バウンディングボックス）
```bash
# 矩形領域指定
python3 commands/quick_interactive.py image.jpg --region 600,800,400,600
```

## テスト結果

Phase 3のテスト結果（失敗画像2枚で検証）：

```
🎯 Phase 3全体成績:
   総テスト数: 4
   成功数: 4
   全体成功率: 100.0%

📈 自動処理からの改善:
   Phase 1+2: 0% (2画像とも全失敗)  
   Phase 3: 100.0%
```

### 生成された抽出結果
- `/tmp/phase3_seeds_21_kana03_0020.jpg` - エフェクト線画像（シードポイント）
- `/tmp/phase3_bbox_21_kana03_0020.jpg` - エフェクト線画像（バウンディングボックス）
- `/tmp/phase3_seeds_16_kana03_0015.jpg` - マルチコマ画像（シードポイント）
- `/tmp/phase3_bbox_16_kana03_0015.jpg` - マルチコマ画像（バウンディングボックス）

各画像には通常版・マスク版・透明背景版が生成されます。

## 技術詳細

### SAM Prompt-based Prediction
- **Point Prompts**: 正負のクリック点を使用したセグメンテーション
- **Box Prompts**: バウンディングボックスを使用したセグメンテーション
- **Multi-mask Output**: 複数候補から最高スコアマスクを自動選択

### 座標指定のコツ
1. **シードポイント**: キャラクターの中心部に正のポイント、背景や不要部分に負のポイント
2. **バウンディングボックス**: キャラクター全体を含む最小矩形
3. **マルチコマ**: 各コマ内のキャラクターに個別にフォーカス

## 改善効果

| Phase | 成功率 | 特徴 |
|-------|--------|------|
| Phase 1 | 50% | 自動パラメータ調整・リトライ |
| Phase 2 | 50% | エフェクト線除去・コマ分割 |
| Phase 3 | 100% | 手動介入・精密指定 |

Phase 3により、自動処理で失敗する複雑な画像でも確実に抽出可能になりました。