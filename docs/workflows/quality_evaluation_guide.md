# 品質評価ガイド

## 📊 概要

segment-anything v0.4.0で抽出されたキャラクター画像の品質評価基準とプロセス。  
手動評価とAI自動評価の両方に対応した統一ガイドライン。

## 🎯 評価基準

### A-Fグレーディングシステム

#### **A評価 (0.8-1.0)** - 優秀な抽出
✅ **使用可能**: ファインチューニング・学習データとして即利用可能

**特徴:**
- キャラクター全体が正確に抽出
- 境界線が自然で滑らか
- 手足、顔などの重要部位が完全
- 背景除去が完璧
- 他キャラクターの混入なし

**例:**
- 全身立ち絵の完璧な抽出
- 表情・ポーズが明確
- 服装の細部まで正確

#### **B評価 (0.6-0.79)** - 良好な抽出
✅ **使用可能**: 軽微な問題はあるが学習利用可能

**特徴:**
- キャラクター主体は正確
- 境界線に軽微なギザギザ
- 重要部位はほぼ完全
- 背景の軽微な残存
- 全体的に使用に問題なし

**例:**
- 髪の細部で軽微な境界不正確
- 服の一部で背景混入
- 手足の先端で軽微な切断

#### **C評価 (0.4-0.59)** - 普通の抽出
⚠️ **要検討**: 使用可能だが品質に問題あり

**特徴:**
- キャラクター主体は認識可能
- 境界線の問題が目立つ
- 重要部位の一部欠損
- 背景除去が不完全
- 補正作業が必要

**例:**
- 手足の一部切断
- 境界線のギザギザが目立つ
- 背景要素の混入

#### **D評価 (0.2-0.39)** - 問題のある抽出
❌ **問題あり**: 重大な問題により使用困難

**特徴:**
- キャラクター形状の大きな歪み
- 重要部位の大幅欠損
- 他オブジェクトの大量混入
- 境界不正確が深刻
- 大幅な補正が必要

**例:**
- 顔の半分が欠損
- 他キャラクターが大量混入
- 背景オブジェクトが主体となっている

#### **E評価 (0.1-0.19)** - 悪い抽出
❌ **使用不可**: 複数の重大な問題

**特徴:**
- キャラクター識別が困難
- 複数の重大欠陥
- 抽出意図と大きく乖離
- 学習データとして有害
- 再処理必須

#### **F評価 (0.0-0.09)** - 失敗した抽出
❌ **完全失敗**: 抽出として成立していない

**特徴:**
- キャラクター抽出の完全失敗
- 全く関係ないオブジェクト
- 空白・ノイズのみ
- 処理エラーの結果
- 削除対象

## 🔍 評価チェックポイント

### 1. キャラクター完全性 (40%)

#### 顔部分 (15%)
- [ ] 顔全体が含まれている
- [ ] 目、鼻、口が正確に抽出
- [ ] 表情が自然に保たれている
- [ ] 髪型が正確に抽出

#### 手足部分 (15%)
- [ ] 両手が適切に抽出
- [ ] 手指の形状が自然
- [ ] 両足が適切に抽出
- [ ] 足先まで完全に含まれている

#### 体幹部分 (10%)
- [ ] 胴体が完全に抽出
- [ ] 服装が正確に抽出
- [ ] アクセサリーが保持

### 2. 境界精度 (25%)

#### 境界線品質 (15%)
- [ ] 境界線が滑らかで自然
- [ ] ギザギザやノイズが最小限
- [ ] エッジ検出が正確
- [ ] 細部まで精密な境界

#### マスク品質 (10%)
- [ ] マスクが正確にキャラクターを捕捉
- [ ] 内部の穴や欠損がない
- [ ] 過剰なマスク拡張がない
- [ ] 不適切なマスク縮小がない

### 3. 背景除去 (20%)

#### 背景クリーン度 (15%)
- [ ] 不要な背景要素がない
- [ ] 吹き出し・テキストが除去
- [ ] 効果線・装飾が除去
- [ ] 他キャラクターが混入していない

#### 透明処理 (5%)
- [ ] 背景が適切に透明化
- [ ] 透明部分にアーティファクトなし
- [ ] エッジの透明処理が自然

### 4. 全体品質 (15%)

#### 構図・ポーズ (10%)
- [ ] 意図したポーズが保持
- [ ] キャラクターが主体として認識可能
- [ ] 重要な特徴が保持
- [ ] 動的なポーズも正確に抽出

#### 色・質感 (5%)
- [ ] 色彩が自然に保持
- [ ] 質感情報が損失していない
- [ ] 明度・コントラストが適切
- [ ] 彩度が自然

## 📝 評価プロセス

### 手動評価フロー

#### 1. 初期スクリーニング (30秒/画像)
1. 画像を開く
2. パッと見の印象で A/B/C/D/E/F を仮判定
3. 明らかな問題があればメモ

#### 2. 詳細チェック (2-3分/画像)
1. 上記チェックポイントを順次確認
2. 各項目を採点
3. 総合スコアを算出
4. 最終グレードを決定

#### 3. コメント記録
```markdown
**評価**: B
**スコア**: 0.72
**問題点**: 
- 右手の指先が軽微に切断
- 背景に吹き出しの一部が残存
**良い点**:
- 顔・表情は完璧
- 全身がバランス良く抽出
**推奨**: そのまま使用可能
```

### 自動評価システム

#### GPT-4O評価
```bash
python features/evaluation/image_evaluation_mcp.py \
  --image [画像パス] \
  --output evaluation_result.json
```

#### Gemini評価
```bash
python features/evaluation/image_evaluation_mcp.py \
  --gemini-key [API_KEY] \
  --image [画像パス]
```

## 📊 品質向上のポイント

### 高品質抽出のための最適化

#### 入力画像品質
- **解像度**: 512px以上推奨
- **圧縮**: 高品質JPEG、無損失PNG
- **キャラクター**: 画面の30%以上を占める
- **背景**: シンプルな背景が理想的

#### パラメータ調整
```bash
# 高品質設定例
--quality_method balanced
--score_threshold 0.07
--enhance_contrast true
--filter_text true
--high_quality true
```

#### 処理順序最適化
1. **前処理**: コントラスト調整、ノイズ除去
2. **YOLO検出**: 適切な閾値設定
3. **SAM分割**: マルチマスク生成
4. **品質評価**: 複数候補から最適選択
5. **後処理**: 境界スムージング、透明化

### 問題パターンと対策

#### よくある問題と解決法

**手足切断**
- 原因: マスク範囲の不足
- 対策: インタラクティブモード使用
- 予防: YOLO閾値を下げる (0.05)

**境界ギザギザ**
- 原因: 低解像度、ノイズ
- 対策: 前処理でスムージング
- 予防: 高解像度画像使用

**背景混入**
- 原因: 複雑背景、類似色
- 対策: マンガモード使用
- 予防: シンプル背景画像選択

**他キャラクター混入**
- 原因: 複数人物検出
- 対策: 手動ポイント指定
- 予防: 単体キャラクター画像選択

## 🎯 用途別品質要求

### LoRA学習用データ
- **最低品質**: B評価以上
- **推奨品質**: A評価
- **許容問題**: 軽微な境界不正確
- **NG要素**: 手足切断、顔欠損

### 展示・プレビュー用
- **最低品質**: C評価以上
- **推奨品質**: B評価以上
- **許容問題**: 中程度の背景混入
- **NG要素**: キャラクター識別不可

### 大量処理・自動化用
- **最低品質**: C評価以上
- **推奨品質**: 全体の70%がB評価以上
- **許容問題**: 一定の品質バラツキ
- **NG要素**: F評価の大量発生

## 📈 品質統計・ベンチマーク

### 期待値 (segment-anything v0.4.0)
- **A評価率**: 30-40%
- **A+B評価率**: 70-80%
- **C評価以下**: 20-30%
- **完全失敗 (F)**: 5%以下

### 改善目標
- **A評価率**: 50%以上
- **A+B評価率**: 85%以上
- **再処理必要**: 15%以下

---

*最終更新: 2025-07-21*  
*バージョン: segment-anything v0.4.0*