# P1-005: モザイク境界処理改善の分析

## 現在の実装分析

### 既存のモザイク検出（ScreentoneBoundaryProcessor）
**場所**: `features/processing/preprocessing/manga_preprocessing.py:408-446`

#### 現在の手法
1. エッジ検出（Canny）
2. 水平・垂直線の形態学的操作
3. 格子パターンの検出
4. 交点周辺の拡張

#### 問題点
1. **固定閾値**: `mosaic_threshold`が画像特性に関係なく固定
2. **シンプルな格子検出**: 複雑なモザイクパターンに対応不足
3. **境界精度不足**: 交点周辺の拡張が大雑把
4. **パターン認識限界**: 回転・歪みのあるモザイクを見逃し
5. **偽陽性問題**: 通常の格子模様もモザイクと誤検出

## 改善が必要な領域

### 1. モザイク検出精度の向上
- **多スケール解析**: 異なるサイズのモザイクパターンに対応
- **回転不変性**: 斜めのモザイクパターンも検出
- **テクスチャ解析**: 模様の規則性を定量化

### 2. 境界処理の精密化
- **エッジ保持**: モザイク境界での過度なブラーを防止
- **適応的処理**: モザイクの種類に応じた境界処理
- **マスク精度**: より正確な境界領域の特定

### 3. キャラクター抽出への統合
- **SAMプロンプト調整**: モザイク領域を考慮したプロンプト生成
- **品質評価**: モザイク境界での抽出品質を評価
- **フォールバック**: モザイク検出失敗時の代替手法

## kaname07処理結果での問題確認

### 観察された問題
1. **境界のボケ**: キャラクターの輪郭が曖昧
2. **スクリーントーンとの混在**: モザイクとスクリーントーンの誤分類
3. **抽出範囲の不正確性**: モザイク境界での切り取り位置のずれ

### 改善目標
- モザイク境界での抽出精度を90%以上に向上
- 偽陽性率を現在の30%から10%以下に削減
- 処理時間を現在の+20%以内に抑制

## 実装計画

### Phase 1: 高度なモザイク検出システム
1. **MultiScaleMosaicDetector**: 多スケール解析による検出
2. **RotationInvariantDetector**: 回転不変なパターン認識
3. **TextureAnalyzer**: 規則性の定量化

### Phase 2: 精密境界処理システム
1. **AdaptiveBoundaryProcessor**: 適応的境界処理
2. **EdgePreservingFilter**: エッジ保持フィルタ
3. **MosaicAwareMasking**: モザイク考慮マスク生成

### Phase 3: 抽出システム統合
1. **MosaicAwareSAMPrompting**: モザイク考慮プロンプト
2. **BoundaryQualityEvaluator**: 境界品質評価
3. **MosaicFallbackSystem**: フォールバック機能