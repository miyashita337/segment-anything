# SAM+YOLO キャラクター抽出システム 技術分析資料

## 1. システム概要

### プロジェクト名
**Segment Anything Model (SAM) + YOLO キャラクター抽出システム v0.3.2**

### 目的
漫画・アニメ画像からキャラクターを自動検出・抽出する高精度システム

### コア技術
- **Meta SAM (Segment Anything Model)**: 高精度セグメンテーション
- **YOLO v8**: 高速物体検出
- **2段階処理**: YOLO境界検出 → SAM精密分割

## 2. 技術仕様・スペック

### アーキテクチャ
```
入力画像 → YOLO検出 → SAM精密分割 → 品質評価 → キャラクター選択 → 結果出力
```

### 処理フロー詳細
1. **画像前処理**: リサイズ、コントラスト調整、ノイズ除去
2. **YOLO検出**: キャラクター候補の境界ボックス検出（閾値0.07）
3. **SAM分割**: YOLOボックスをプロンプトとした精密セグメンテーション
4. **品質評価**: 5つの評価手法で最適結果を選択
5. **後処理**: マスク適用、背景除去、最終出力

### 品質評価システム
1. **balanced**: バランス重視（推奨）
2. **confidence_priority**: 信頼度優先
3. **size_priority**: サイズ優先
4. **fullbody_priority**: 全身検出優先
5. **central_priority**: 中心位置優先

### 技術的制約
- **対応画像**: 漫画・アニメ画像特化（1496x2112解像度）
- **処理能力**: 5-8秒/画像
- **推奨環境**: GPU必須（8GB VRAM以上）
- **依存関係**: PyTorch 1.7+, OpenCV, ultralytics

## 3. 現状の問題点

### 主要問題
1. **キャラクター選択の複雑さ**: 複数キャラクターシーンでの選択精度が低い
2. **システムの複雑性**: Character extraction systemが複雑で改善箇所の特定が困難
3. **地域優先度の不足**: 画面位置に基づく選択が不十分

### 成功率データ
- **現在の成功率**: 58.5%（41枚中24枚成功）
- **目標成功率**: 80%以上
- **主要失敗要因**: wrong_character_selection（間違ったキャラクター選択）

### 具体的失敗パターン
```json
{\"actual_problem\": \"wrong_character_selection\", \"count\": 15},
{\"actual_problem\": \"extraction_failure\", \"count\": 16},
{\"actual_problem\": \"inappropriate_extraction_area\", \"count\": 5}
```

## 4. 技術的現状と進捗

### v0.3.2 実装済み機能
- **RegionPrioritySystem**: 地域優先度システム
- **ユーザー評価データ統合**: 41枚の画像評価データ
- **位置ベース選択**: 画面領域別優先度（上部、下部、左、右、中央）

### v0.3.1 改善点
- **モザイク検出無効化**: 偽陽性を引き起こすモザイク処理を無効化
- **一時ファイル管理**: /tmp/での前処理ファイル管理
- **自動クリーンアップ**: バッチ処理後の一時ファイル削除

### v0.3.0 Phase 1改善
- **包括的品質評価**: 6つの評価システム（P1-001〜P1-006）
- **パーシャル抽出検出**: 不完全抽出の検出システム
- **スクリーントーン検出**: 漫画特化の高度パターン認識

## 5. 要件定義

### 機能要件
1. **抽出精度向上**: 58.5% → 80%以上への改善
2. **複数キャラクター対応**: 漫画パネルでの正確な対象キャラクター選択
3. **地域指定対応**: ユーザー指定領域での優先抽出
4. **システム簡素化**: 複雑なシステムをより直接的なアプローチに改善

### 非機能要件
1. **処理速度**: 5秒/画像以下を維持
2. **メモリ使用量**: 8GB VRAM以下
3. **安定性**: 長時間バッチ処理での安定動作
4. **拡張性**: 新しい評価手法の追加が容易

## 6. 現在のコードベース構造

### モジュール構成
```
features/
├── extraction/
│   ├── commands/extract_character.py    # メイン抽出ロジック
│   └── models/                          # SAM/YOLOラッパー
├── evaluation/
│   ├── utils/learned_quality_assessment.py  # 品質評価
│   ├── utils/region_priority_system.py      # 地域優先度
│   └── logs/kaname07_user_evaluation.jsonl  # ユーザー評価データ
├── processing/
│   ├── preprocessing/               # 前処理
│   └── postprocessing/             # 後処理
└── common/
    ├── hooks/                      # 初期化
    └── performance/               # パフォーマンス監視
```

### 主要クラス
- **CharacterExtractor**: メイン抽出クラス
- **RegionPrioritySystem**: 地域優先度システム
- **DifficultPoseProcessor**: 困難姿勢処理
- **LearnedQualityAssessment**: 学習型品質評価

## 7. ユーザー評価データ分析

### 評価データサンプル
```json
{
  \"user_rating\": \"F\",
  \"desired_region\": \"画面左側\",
  \"actual_problem\": \"wrong_character_selection\",
  \"notes\": \"本当は画面左側のキャラを抽出してほしかった\"
}
```

### 問題分布
- **間違ったキャラクター選択**: 36.6%（15/41）
- **抽出失敗**: 39.0%（16/41）
- **不適切な抽出範囲**: 12.2%（5/41）
- **成功**: 12.2%（5/41）

### 地域要求パターン
- 画面上部: 4件
- 画面下部: 3件
- 画面左側: 2件
- 画面右側: 3件
- 特定コマ: 8件

## 8. 技術的課題と分析要求

### 現在の技術課題
1. **複雑なキャラクター選択ロジック**: 複数の評価手法が絡み合い、最適解の特定が困難
2. **地域優先度の統合**: RegionPrioritySystemが他の評価システムと独立して動作
3. **ユーザー意図の反映**: 評価データが存在するが、効果的な学習システムが不足

### 分析要求
1. **アーキテクチャ評価**: 現在のYOLO→SAM→品質評価の流れは最適か？
2. **キャラクター選択最適化**: 複数候補から正確な選択を行う最適なアプローチは？
3. **システム統合**: 複雑なシステムをシンプルにする直接的アプローチは？
4. **機械学習統合**: ユーザー評価データを活用した学習システムの設計は？

## 9. 期待される改善案

### 技術的改善案
1. **統合評価システム**: 複数の評価手法を統一的に処理
2. **学習ベース選択**: ユーザー評価データから学習する選択システム
3. **前処理最適化**: 漫画特化の前処理による精度向上
4. **後処理簡素化**: 結果選択・絞り込みの最適化

### アーキテクチャ改善案
1. **エンドツーエンド学習**: YOLO+SAM+選択を統合した学習システム
2. **注意機構**: 地域優先度を注意機構で実装
3. **強化学習**: ユーザーフィードバックを報酬とした強化学習
4. **アンサンブル手法**: 複数の選択手法を組み合わせた投票システム

## 10. 実装制約

### 技術制約
- **既存コードベース**: 大規模な書き換えは困難
- **処理速度**: リアルタイム処理が要求される
- **メモリ制限**: GPU VRAMの制約

### 運用制約
- **バッチ処理**: 大量画像の自動処理が必要
- **安定性**: 長時間実行での安定動作
- **拡張性**: 新しい評価手法の追加が容易でなければならない

---

この分析資料を基に、より効率的で精度の高いキャラクター抽出システムの設計について、技術的見解と具体的な改善アプローチを提案してください。