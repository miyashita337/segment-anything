# AI協議議事録 - v0.4.0全身抽出回帰問題

**日時**: 2025-07-21 12:30  
**参加AI**: Claude Code, GPT-4O (via o3-search)  
**議題**: v0.4.0で発生した全身抽出→顔のみ抽出への品質劣化問題

## 📋 問題概要

### 症状
- **v0.3.5**: ある程度成功していた全身キャラクター抽出
- **v0.4.0**: 出力された画像がすべて顔しか抽出されない
- **影響**: 「漫画キャラクターのできるだけ全身を自動で抽出させる」という目的に対する重大な品質劣化

### 変更点分析
GitHub PR #8の主要変更:
- **P1-006 Solid Fill Detection**の追加
- `enable_solid_fill_detection`パラメータの導入
- 前処理パイプラインへの統合

## 🔍 要求分析

### Claude分析（技術的観点）
**根本原因**:
1. **固定エッジマージン問題** (最重要)
   - `enhanced_solid_fill_processor.py:346`: 画像端10%以内を強制的に'background'分類
   - 漫画パネルでキャラクターが境界に接している場合、体の部位が削除される

2. **分類ロジックの偏り**
   - 黒い領域のアスペクト比>1.5のみを'character'判定（髪特化）
   - 服装や体の部位（特にスクリーントーン処理）が'background'扱い

3. **SAM統合順序問題**
   - Solid fill処理 → SAM処理の順序
   - 削除された領域はSAMでも復活しない

### GPT-4O分析（ユーザビリティ観点）
**システム設計上の問題**:
- Solid fill detectionは背景ノイズ除去に有効だが、キャラクター判定が過度に保守的
- 境界品質評価がコンパクトな形状（顔）を過度に優遇
- パラメータがハードコード化されており、画像特性に適応できない

## 📊 提案案

### 案1: Claude提案（段階的修正）
**概要**: Solid fill detection機能を保持し、分類精度を向上
**メリット**:
- P1-006の開発投資を無駄にしない
- 背景除去機能を維持
- 段階的な品質改善が可能

**デメリット**:
- 複雑な調整が必要
- 完全な回復保証なし

**工数**: 2.5人日
- パラメータ調整: 0.5人日
- 分類ロジック改善: 1.5人日
- テスト・検証: 0.5人日

**技術詳細**:
```yaml
修正箇所:
  - enhanced_solid_fill_processor.py: エッジマージン適応化
  - extract_character.py: YOLO/SAM事前情報注入
  - difficult_pose.py: フォールバック機構追加

パラメータ変更:
  - edge_threshold: 0.10 → adaptive(0.03, cap=24px)
  - min_region_area: 0.005 → 0.002
  - 色均一性閾値緩和: σ_L(3→6), σ_ab(4→8)
```

### 案2: GPT提案（機能無効化+選択的利用）
**概要**: Solid fill detectionをデフォルト無効化、オプション機能化
**メリット**:
- 即座にv0.3.5レベルの品質回復
- リスクが低い
- 将来的な機能改善の余地を残す

**デメリット**:
- 背景ノイズ除去能力の喪失
- P1-006開発投資が一時的に無効化

**工数**: 1.5人日
- デフォルト値変更: 0.2人日
- コマンドライン引数追加: 0.3人日
- テスト・検証: 1.0人日

**技術詳細**:
```yaml
修正箇所:
  - extract_character.py: solid_fill_detection=False as default
  - コマンドライン: --enable-solid-fill フラグ追加
  - ドキュメント: 使用条件の明記

条件付き有効化:
  - 背景が複雑な画像のみ手動有効化
  - バッチ処理では無効化推奨
```

### 案3: ハイブリッド案（GPT追加提案）
**概要**: 自動判定による選択的適用
**メリット**:
- 画像特性に応じた最適化
- ユーザー操作不要
- 両方の利点を活用

**デメリット**:
- 実装複雑度が高い
- 判定ロジックの追加コスト

**工数**: 3.0人日
- 画像複雑度判定: 1.0人日
- 自動切り替えロジック: 1.5人日
- テスト・検証: 0.5人日

## 🎯 協議結果

### 推奨案: **案1（段階的修正）**
**理由**:
1. **投資保護**: P1-006の技術的価値を維持
2. **品質バランス**: 全身抽出復活 + 背景除去維持
3. **学習効果**: 問題解決プロセスの経験蓄積
4. **拡張性**: 将来的な機能改善の基盤

### 代替案: **案2（機能無効化）**
**適用条件**: 案1で2週間以内に品質改善が見られない場合のフォールバック

## 🚨 APIリミット状況
- **Claude**: 正常動作
- **GPT-4O**: o3-search経由で利用、制限なし
- **次回引き継ぎ事項**: なし

## 📈 成功指標

### 定量指標
- **全身抽出成功率**: ≥90% (v0.3.5レベル)
- **B評価達成率**: ≥50% (ワークフロー基準)
- **背景誤検出率**: ≤v0.4.0レベル (5%以下)

### 測定方法
- kana08データセット（26画像）での回帰テスト
- v0.3.5, v0.4.0, v0.4.1の3バージョン比較
- 人間評価 + 自動評価の併用

## 🔄 次回アクション
1. PROGRESS_TRACKER.mdへのISSUE登録
2. 技術仕様書の詳細化
3. テスト要件の定義
4. 人間によるLGTM承認