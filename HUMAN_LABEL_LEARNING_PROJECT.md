# 人間ラベルデータ活用キャラクター抽出学習プロジェクト

## 🎯 プロジェクト概要

### 目標
**101ファイルの人間ラベルデータを活用して「一番大きいコマのキャラクター抽出」精度を根本的に向上させる**

### 背景
- 現在のSAM/YOLOシステムでは62.5%がF評価の問題を抱える
- 人間が作成した赤枠ラベルデータが101ファイル利用可能
- GPT-4Oとの協議により段階的転移学習アプローチが最適と判明

### 成功基準
- **Largest-Character Accuracy**: 80%以上（現状: 評価中）
- **A/B評価率**: 70%以上（現状: 約25%）
- **処理速度**: 5秒/画像以下を維持

---

## 📊 データセット分析結果

### 人間ラベルデータの特徴
- **総ファイル数**: 101（kana05: 36, kana07: 40, kana08: 25）
- **赤枠検出成功率**: 100%（全ファイルで座標抽出成功）
- **平均アスペクト比**: 1.28（縦長傾向）
- **支配的抽出タイプ**: face_close（顔アップが最多）
- **抽出範囲**: 全身・バストアップ・顔アップの混在

### 技術的洞察
- 豊富なラベルデータ（80+）により深層学習アプローチが有効
- データ不足対策として疑似ラベル+人手修正で3-5倍拡張が必要
- 段階的転移学習（COCO→Manga109→自前データ）が必須

---

## 🚀 段階的実装戦略（GPT-4O協議結果）

### Phase 0: ルールベースベンチマーク 🎯
**目的**: 現状性能の定量化と改善基準の確立

**実装内容**:
- 既存YOLO/SAM + 面積最大選択でベースライン測定
- "Largest-Character Accuracy"指標の確立
- mAP/mIoU測定システム構築

**成功基準**:
- [ ] ベースライン精度測定完了
- [ ] 評価指標システム構築
- [ ] 101ファイルでの性能測定結果取得

**推定工数**: 3-5日

---

### Phase 1: コマ検出ネット構築 🔧
**目的**: 「一番大きいコマ」の自動判別システム構築

**実装内容**:
- Mask R-CNN/YOLOv8-segのマンガ特化転移学習
- COCO→Manga109→自前101ファイルの3段階学習
- コマ境界検出精度の向上

**技術スタック**:
- **モデル**: Mask R-CNN, YOLOv8-seg
- **損失関数**: Dice + BCE
- **データ**: 101+疑似ラベル拡張データ

**成功基準**:
- [ ] コマ検出mIoU: 80%以上
- [ ] 大型コマ判別精度: 85%以上
- [ ] 推論速度: 2秒/画像以下

**推定工数**: 10-14日

---

### Phase 2: キャラ検出+サイズランキング 🎨
**目的**: コマ内での高精度キャラクター検出

**実装内容**:
- Detectron2とYOLOv8のアンサンブル
- コマ内限定での高精度キャラクター検出
- 面積ベースでの最適キャラクター選択

**技術スタック**:
- **モデル**: Detectron2 + YOLOv8 アンサンブル
- **入力**: Phase 1で切り出したコマ内画像
- **出力**: 面積最大のキャラクターbbox

**成功基準**:
- [ ] キャラクター検出mAP@0.5: 85%以上
- [ ] Largest-Character Accuracy: 75%以上
- [ ] 誤検出率: 15%以下

**推定工数**: 14-21日

---

### Phase 3: 主人公判定ヘッド（オプション） 🧠
**目的**: 複数キャラクター中の主人公自動識別

**実装内容**:
- CLIP-ViT特徴による同一人物識別
- 最頻出キャラクターを主人公として優先選択
- 履歴ベースの主人公追跡システム

**技術スタック**:
- **特徴抽出**: CLIP-ViT
- **類似度計算**: コサイン類似度 / ArcFace損失
- **判定**: 履歴ベース + サイズベース統合判定

**成功基準**:
- [ ] 主人公識別精度: 80%以上
- [ ] 誤判定による性能劣化: 5%以下
- [ ] 処理時間増加: 1秒以下

**推定工数**: 7-10日

---

### Phase 4: End-to-End微調整 🌟
**目的**: 全体最適化による最終精度向上

**実装内容**:
- DETR-type Transformer（Pix2Seq v2等）によるマルチタスク学習
- コマ検出→キャラクター検出→ランキングの一括最適化
- 101+拡張データでのfine-tune

**技術スタック**:
- **アーキテクチャ**: DETR, Pix2Seq v2
- **出力**: コマbbox → キャラbbox → ランキングtoken
- **学習**: マルチタスク損失による一括最適化

**成功基準**:
- [ ] Largest-Character Accuracy: 85%以上
- [ ] A/B評価率: 75%以上
- [ ] 総合処理時間: 5秒/画像以下

**推定工数**: 14-21日

---

## 📏 評価指標システム

### 主要指標
1. **mAP@0.5 / mAP@[.5:.95]**: キャラクターbbox精度
2. **mIoU**: コママスク精度
3. **Largest-Character Accuracy**: 画像単位での「最大キャラ正解率」
4. **主人公一致率**: Phase 3以降での主人公識別精度
5. **推論速度 FPS**: 実運用性能

### 評価データセット
- **学習用**: 101ファイル + 疑似ラベル拡張データ
- **検証用**: Stratified 5-fold CV（作品/話数ごと分割）
- **テスト用**: 未見データでの最終評価

---

## 🛠 技術スタック・環境

### 開発環境
- **フレームワーク**: PyTorch 2.3 + Lightning 2.x
- **学習管理**: W&B sweeps（ハイパーパラメータ自動探索）
- **推論**: Torch-script → ONNX/TensorRT変換対応

### データ拡張戦略
- **幾何変換**: 回転(±2°)、スケール(0.9-1.1)、左右反転
- **画質変換**: Gaussian noise, JPEG artifact（印刷劣化模擬）
- **スタイル変換**: 白黒⇄スクリーントーン、輪郭線太さjitter
- **コンポジット**: 2コマ連結による誤検出耐性向上

### 過学習対策
- **交差検証**: Stratified 5-fold CV
- **Early Stopping**: patience 10、mIoU/Largest-Character Accuracy監視
- **正則化**: Weight Decay 1e-4、DropBlock/DropPath
- **データ拡張**: Mixup=0.2、Cutout=0.3

---

## 📈 進捗管理・マイルストーン

### 完了済み ✅
- [x] 赤枠座標自動抽出システム構築（100%成功率）
- [x] 101ファイルラベルデータ詳細分析
- [x] GPT-4Oとの学習アプローチ協議
- [x] 統合進捗管理システム構築

### 進行中 🔄
- [ ] Phase 0: ルールベースベンチマーク作成

### 今後の予定 📋
- [ ] データ拡張システム構築
- [ ] Phase 1: コマ検出ネット構築
- [ ] Phase 2: キャラ検出+ランキング
- [ ] Phase 3: 主人公判定（オプション）
- [ ] Phase 4: End-to-End微調整

---

## 🎯 期待成果・ビジネス価値

### 技術的成果
- **抽出精度**: 現状25% → 目標75%のA/B評価率
- **自動化率**: 人手介入なしでの高品質抽出実現
- **汎用性**: 他の漫画作品への転用可能な学習済みモデル

### プロダクト価値
- **LoRA学習効率化**: 高品質データによる学習時間短縮
- **品質標準化**: 一貫した抽出品質の確保
- **スケーラビリティ**: 大量データ処理への対応

---

## 📞 連絡先・リソース

### プロジェクト管理
- **進捗追跡**: TodoWriteツール統合システム
- **成果測定**: 自動評価・レポート生成
- **課題管理**: 技術的課題の記録・対策管理

### 重要ファイル
- **ラベルデータ**: `/mnt/c/AItools/segment-anything/extracted_labels.json`
- **分析結果**: `/mnt/c/AItools/segment-anything/label_analysis/`
- **協議記録**: `/mnt/c/AItools/segment-anything/gpt4o_consultation_summary.md`

### 次回更新予定
**Phase 0完了時**（推定: 3-5日後）
- ベースライン性能測定結果
- 評価指標システム詳細
- Phase 1実装計画の詳細化

---

*最終更新: 2025-07-23*  
*次回更新予定: Phase 0完了後*